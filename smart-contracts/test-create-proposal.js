const { NodeVM } = require('vm2')
const fs = require('fs')

;(async () => {
  try {
    const HORIZON_URL = 'https://horizon-testnet.stellar.org'
    const STELLAR_NETWORK = 'TESTNET'

    const vm = new NodeVM({
      // console: 'off',
      eval: false,
      wasm: false,
      strict: true,
      fixAsync: true,
      sandbox: {
        HORIZON_URL,
        STELLAR_NETWORK,
        window: {}
      },
      require: {
        builtin: ['util'],
        external: {
          modules: ['bignumber.js', 'node-fetch', 'stellar-sdk', 'lodash', 'toml', 'sha']
        },
        context: 'host',
      }
    })

    const txFunctionCode = fs.readFileSync('./dist/txFunction.js', 'utf8')
    const result = await vm.run(txFunctionCode, 'vm.js')({
      action: 'create',
      sourceAccountId: 'GBRSHO6SLY42BT2PTLOXMUX6UPLUUNLJSISOPHB2F5UORNOYE5E5QJKJ', // SC22VCR2R4RYDVVRTBEDL6C3OWZIOJ5EQNQGKKFD2PFX3IPHVPFEUS74
      nonceAccountId: 'GC2TMSHJRVUOHF4J7JZPCKAXBXWYECQJW2KOMLCAWDTMP5HOHBC2LQAH',
      proposalSecret: 'SANJAFLXD7IJI7CPV4OM5YK6GMHKAIWHXSSDJFJCHJDMPXS74VV6LLKU', //GB6XTTLL4ZNRVBPPGFQFJQCVCQ7VMVIO4XVTKRWQKHQIFJ6EL2DZUNS3
      turretSigners:'GDDDOUR6R2QH4XEEOXGEI2ATXALXVEJWQVPKVSJSDFBDEZCBMIXTXEZP, GD2YNDEEGLOCCIX7BMFRAJYZ6MKICMOFAVQQSHUEHFOAXNNANLIN2DIA, GAYUDL2E7MEF3EAUMFVX5FLIHLCDND5PZQTP2CPIMWHXF242JAW47ZPP, GCW7YUGHVOIYFOIYI2KMO6A5HRA3HXAZ66Z6Z5D5M3WOETA2722ZRMZ4, GALFAVC7F33IR5XU7N5OQHF7YUKI5AZ5TV6WCR6DGLCGAV3QH3W5IYAK',
      daoTomlHost: 'https://soneso.com',
      proposalLink: 'https://bit.ly/3GqrozZ'
    })
  
    console.log(result)
  }

  catch(err) {
    console.error(err)
  }
})()

/* 
TEST DATA:
DAO Public Key: GAZZWLZCTLL2GMEICJWMGF4T3BDE6QTQEQDCBKJGXKUUD3D66THAGDAO / SCLMFYDVD3SDTHXLQH2C67IJTBP63QQS6XZW6KXFNLURTZJHJDJSW7OK
Token: GOV:GBNOMH3B6BIQE65TZVVBNOCTMLN7MYORU5GX6YNBX5YBGCI45R2EMGOV / SBDT5Z3CPSHZ74224EP5DLGVO56J755FSTQZPDQ5WCCOOCAJMY4HL2M6

turrets:
Public Key	GDDDOUR6R2QH4XEEOXGEI2ATXALXVEJWQVPKVSJSDFBDEZCBMIXTXEZP
Secret Key	SDTNUXPXA6EMXAUF65EHROZI5HZ4Q6H2BENJSZEF66PE4DNWAYI4WH7Y

Public Key	GD2YNDEEGLOCCIX7BMFRAJYZ6MKICMOFAVQQSHUEHFOAXNNANLIN2DIA
Secret Key	SCEDDKBRXIFIKRJ5AZ7IE4HGW4DBACV6AXOQA2PV2PZQ32CRVN5VKEP2

Public Key	GAYUDL2E7MEF3EAUMFVX5FLIHLCDND5PZQTP2CPIMWHXF242JAW47ZPP
Secret Key	SCUIQ2FULBY6I6M47XCL2MFB64ZG4LZWBOX5UJKBDZF77RUNCYBYAP5Y

Public Key	GCW7YUGHVOIYFOIYI2KMO6A5HRA3HXAZ66Z6Z5D5M3WOETA2722ZRMZ4
Secret Key	SATEUDAJO7CEF435NCT7IBNKXBJUMIA6EZMFT5F7HOI4CHXEL5OX4OFZ

Public Key	GALFAVC7F33IR5XU7N5OQHF7YUKI5AZ5TV6WCR6DGLCGAV3QH3W5IYAK
Secret Key	SBBENNBOCUX6V3OEJUNX6KQLQ3JEEOFD6F2A7SCNOJLZBU2SM4KBJAZF


proposal rescue accounts:
Public Key	GCBY2B7KKVE4T66B4ZECNLOYT3Y772GHJTATP33IDUSYXTZSJNNYRWX5
Secret Key	SBYAYPDNDUJBZIU3ZQDVKLG2RDGUGRFUUV22V3L2KIGUWEQR5LJTWTEL

Public Key	GAA72JLMNMAIZ44XYYNKACANN6THCU7MLKB4M3YDFOHI4IEU4PLTDLLY
Secret Key	SCHQ5X7GTYJ6XTELA2VOKKDXP5G2VU46PFJXYHD74QCSIWWLF2RR5Y44

Public Key	GDUGCQEZ5XOCZ6MDXI44ZALD4GDJBHE6XZAXPRB7DTGJ6O2S76VG7FML
Secret Key	SDEFYA2VFUZAJKVEHSBYE7XZJDLXDADYXEDGD4Q3JUDNN3R23ZKPXBEN

test accounts
Public Key	GBH2S2VYTEMUYJHAM3EBX7VGWAZCAW4SEL2L6CKTJMHUYFL63QR7YVBE
Secret Key	SCT6S4J2CGDZ7NCDJR3EV5BCBEWOC5NDGTDK5RHKI7XIBQWZFCY5MRNG

Public Key	GA7N4T36SJS3XNSF4LWN7ZEEK5RPHU4SP72SI6J3WZDO5PMVTLMVLLBJ
Secret Key	SARAPKZPHSKPXCVUGECHJ7MGPOLSWEXOMR3WY3V67HLMDOONMJADJL6K

xdr options account:
Public Key	GC3HDF7ZTDMOJLKSDIMNUTCAWUUMQRHGTW3Y3IW546ROKVPONZFSLAGO
Secret Key	SBETRO4EW3C6MZFBHUCUYYOGIJOXZLYZGPY46WPX2EQTISEV2YEUCZGV
*/