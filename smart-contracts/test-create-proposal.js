const { NodeVM } = require('vm2')
const fs = require('fs')

;(async () => {
  try {
    const HORIZON_URL = 'https://horizon-testnet.stellar.org'
    const STELLAR_NETWORK = 'TESTNET'

    const vm = new NodeVM({
      // console: 'off',
      eval: false,
      wasm: false,
      strict: true,
      fixAsync: true,
      sandbox: {
        HORIZON_URL,
        STELLAR_NETWORK,
        window: {}
      },
      require: {
        builtin: ['util'],
        external: {
          modules: ['bignumber.js', 'node-fetch', 'stellar-sdk', 'lodash']
        },
        context: 'host',
      }
    })

    const txFunctionCode = fs.readFileSync('./dist/txFunction.js', 'utf8')
    const result = await vm.run(txFunctionCode, 'vm.js')({
      stage: 'create',
      daoToml: 'https://turretsdao.org/.well-known/dao.toml',
      source: 'GBRSHO6SLY42BT2PTLOXMUX6UPLUUNLJSISOPHB2F5UORNOYE5E5QJKJ',
      proposalSecret: 'SBXF4BWWIY3GI5RYKK4VBOIZVJ4HLTAKCUKRE3CENAQAVXTA5FAPX4VR', //GAX5YKLGPWDIXB2577ZXUHJ6ODLXA75JY7XH34KVMZF6DM7SX7V74GBT
      turretSigners:'GDDDOUR6R2QH4XEEOXGEI2ATXALXVEJWQVPKVSJSDFBDEZCBMIXTXEZP, GD2YNDEEGLOCCIX7BMFRAJYZ6MKICMOFAVQQSHUEHFOAXNNANLIN2DIA, GAYUDL2E7MEF3EAUMFVX5FLIHLCDND5PZQTP2CPIMWHXF242JAW47ZPP, GCW7YUGHVOIYFOIYI2KMO6A5HRA3HXAZ66Z6Z5D5M3WOETA2722ZRMZ4, GALFAVC7F33IR5XU7N5OQHF7YUKI5AZ5TV6WCR6DGLCGAV3QH3W5IYAK',
      IpfsProposalAddr: 'https://test.data.io/proposal1223'
    })
  
    console.log(result)
  }

  catch(err) {
    console.error(err)
  }
})()

/* turrets (test)
Public Key	GDDDOUR6R2QH4XEEOXGEI2ATXALXVEJWQVPKVSJSDFBDEZCBMIXTXEZP
Secret Key	SDTNUXPXA6EMXAUF65EHROZI5HZ4Q6H2BENJSZEF66PE4DNWAYI4WH7Y

Public Key	GD2YNDEEGLOCCIX7BMFRAJYZ6MKICMOFAVQQSHUEHFOAXNNANLIN2DIA
Secret Key	SCEDDKBRXIFIKRJ5AZ7IE4HGW4DBACV6AXOQA2PV2PZQ32CRVN5VKEP2

Public Key	GAYUDL2E7MEF3EAUMFVX5FLIHLCDND5PZQTP2CPIMWHXF242JAW47ZPP
Secret Key	SCUIQ2FULBY6I6M47XCL2MFB64ZG4LZWBOX5UJKBDZF77RUNCYBYAP5Y

Public Key	GCW7YUGHVOIYFOIYI2KMO6A5HRA3HXAZ66Z6Z5D5M3WOETA2722ZRMZ4
Secret Key	SATEUDAJO7CEF435NCT7IBNKXBJUMIA6EZMFT5F7HOI4CHXEL5OX4OFZ

Public Key	GALFAVC7F33IR5XU7N5OQHF7YUKI5AZ5TV6WCR6DGLCGAV3QH3W5IYAK
Secret Key	SBBENNBOCUX6V3OEJUNX6KQLQ3JEEOFD6F2A7SCNOJLZBU2SM4KBJAZF

*/